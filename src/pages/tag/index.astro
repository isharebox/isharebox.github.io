---
import Layout from "@/layouts/Layout.astro";
import { getPageList } from "@/pages/api/post/list";
import config from "urodele.config";

const allPosts = await getPageList();

// 统计标签
const tagCount: Record<string, number> = {};
allPosts.forEach((post: any) => {
  post.tags?.forEach((tag: string) => {
    tagCount[tag] = (tagCount[tag] || 0) + 1;
  });
});

// 按数量排序
const sortedTags = Object.entries(tagCount)
  .sort((a, b) => b[1] - a[1]);

// 序列化数据
const postsData = allPosts.map((p: any) => ({
  id: p.id,
  title: p.title,
  intro: p.intro,
  createTime: p.createTime,
  tags: p.tags || []
}));
---

<Layout title={`Tags | ${config.head.brand}`}>
  <main>
    <div class="content">
      <!-- 搜索框 -->
      <div class="search-box">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input 
          type="search" 
          id="search-input" 
          class="search-input" 
          placeholder="Search tags or posts..."
          autocomplete="off"
        />
      </div>

      <!-- 标签云 - 显示数量 -->
      <h2 class="section-title">Trending Tags</h2>
      <div class="tag-cloud" id="tag-cloud">
        {sortedTags.map(([tag, count]) => (
          <a href={`/tag/${encodeURIComponent(tag)}`} class="tag-card">
            <span class="tag-name">#{tag}</span>
            <span class="tag-num">{count}</span>
          </a>
        ))}
      </div>

      <!-- 搜索结果 - 紧凑列表 -->
      <div id="search-results" style="display: none;">
        <h2 class="section-title" id="results-title">Results</h2>
        <ul class="post-list" id="post-list"></ul>
        <a href="/tag" class="back-link" onclick="resetSearch(event)">← Clear search</a>
      </div>
    </div>
  </main>
</Layout>

<script define:vars={{ postsData }}>
  const searchInput = document.getElementById('search-input');
  const tagCloud = document.getElementById('tag-cloud');
  const searchResults = document.getElementById('search-results');
  const postList = document.getElementById('post-list');
  const resultsTitle = document.getElementById('results-title');

  function formatDate(dateStr) {
    return new Date(dateStr).toISOString().split('T')[0];
  }

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // 紧凑列表渲染 - 与主页一致
  function renderPosts(posts, query) {
    if (posts.length === 0) {
      postList.innerHTML = '<li class="empty-state">No results found</li>';
      return;
    }

    postList.innerHTML = posts.map(post => `
      <li class="post-item">
        <time class="post-date">${formatDate(post.createTime)}</time>
        <a href="/post/${post.id}" class="post-title">${escapeHtml(post.title)}</a>
      </li>
    `).join('');
  }

  function resetSearch(e) {
    e.preventDefault();
    searchInput.value = '';
    tagCloud.style.display = 'flex';
    searchResults.style.display = 'none';
  }

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    
    if (!query) {
      tagCloud.style.display = 'flex';
      searchResults.style.display = 'none';
      return;
    }

    tagCloud.style.display = 'none';
    searchResults.style.display = 'block';
    resultsTitle.textContent = query ? `Search: "${query}"` : 'All Posts';

    const filtered = postsData.filter(p => 
      p.title.toLowerCase().includes(query) ||
      (p.intro && p.intro.toLowerCase().includes(query)) ||
      p.tags.some(t => t.toLowerCase().includes(query))
    );

    renderPosts(filtered, query);
  });
</script>

<style>
  /* 居中布局 - 与主页一致 */
  main {
    display: flex;
    justify-content: center;
    width: 100%;
    padding: 0 16px;
  }

  .content {
    width: 100%;
    max-width: 720px;
    padding: 2rem 0;
  }

  /* 搜索框 */
  .search-box {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: #05282a;
    border: 1px solid #1a4a4c;
    border-radius: 24px;
    margin-bottom: 2rem;
  }

  .search-icon {
    color: #8ab3b3;
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    color: #e8f4f4;
    font-size: 1rem;
    outline: none;
  }

  .search-input::placeholder {
    color: #565f89;
  }

  /* 标题 */
  .section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #e8f4f4;
    margin: 1.5rem 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px dashed #1a4a4c;
  }

  /* 标签云 - 显示数量 */
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .tag-card {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #05282a;
    border: 1px solid #1a4a4c;
    border-radius: 20px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .tag-card:hover {
    border-color: #3da0a3;
    background: rgba(61, 160, 163, 0.1);
  }

  .tag-name {
    color: #3da0a3;
    font-size: 0.9rem;
  }

  .tag-num {
    padding: 0.1rem 0.4rem;
    background: #1a4a4c;
    border-radius: 10px;
    font-size: 0.75rem;
    color: #8ab3b3;
  }

  /* 紧凑列表 - 与主页完全一致 */
  .post-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .post-item {
    display: flex;
    align-items: baseline;
    gap: 1.5rem;
    padding: 0.35rem 0;
    transition: background 0.15s;
  }

  .post-item:hover {
    background: rgba(42, 124, 126, 0.05);
  }

  .post-date {
    font-family: "SF Mono", Monaco, monospace;
    font-size: 0.8rem;
    color: #8ab3b3;
    min-width: 90px;
    flex-shrink: 0;
  }

  .post-title {
    color: #3da0a3;
    font-size: 0.95rem;
    text-decoration: none;
    transition: color 0.2s;
  }

  .post-title:hover {
    color: #e8f4f4;
    text-decoration: underline;
  }

  .back-link {
    display: block;
    margin-top: 2rem;
    color: #8ab3b3;
    font-size: 0.9rem;
    text-decoration: none;
  }

  .back-link:hover {
    color: #3da0a3;
  }

  .empty-state {
    padding: 2rem;
    text-align: center;
    color: #8ab3b3;
  }
</style>
