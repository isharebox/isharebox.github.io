---
import Layout from "@/layouts/Layout.astro";
import { getPageList } from "@/pages/api/post/list";
import config from "urodele.config";

const allPosts = await getPageList();

// 统计标签
const tagCount: Record<string, number> = {};
allPosts.forEach((post: any) => {
  post.tags?.forEach((tag: string) => {
    tagCount[tag] = (tagCount[tag] || 0) + 1;
  });
});

// 按数量排序
const sortedTags = Object.entries(tagCount)
  .sort((a, b) => b[1] - a[1])
  .map(([tag, count]) => ({ tag, count }));

// 序列化数据给客户端
const postsData = allPosts.map((p: any) => ({
  id: p.id,
  title: p.title,
  intro: p.intro,
  createTime: p.createTime,
  tags: p.tags || []
}));
---

<Layout title={`Tags | ${config.head.brand}`}>
  <main>
    <div class="content">
      <h1 class="page-title">Tags</h1>
      
      <!-- 搜索框 -->
      <div class="search-box">
        <input 
          type="search" 
          id="search-input" 
          class="search-input" 
          placeholder="Search posts..."
          autocomplete="off"
        />
        <button class="search-btn" id="search-btn">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M11.7422 10.3439C12.5329 9.2673 13 7.9382 13 6.5C13 2.91015 10.0899 0 6.5 0C2.91015 0 0 2.91015 0 6.5C0 10.0899 2.91015 13 6.5 13C7.9382 13 9.2673 12.5329 10.3439 11.7422L14.1464 15.5456L15.5456 14.1464L11.7422 10.3439ZM6.5 11C4.01472 11 2 8.98528 2 6.5C2 4.01472 4.01472 2 6.5 2C8.98528 2 11 4.01472 11 6.5C11 8.98528 8.98528 11 6.5 11Z"/>
          </svg>
          Search
        </button>
      </div>

      <!-- 标签云 -->
      <div class="tag-cloud" id="tag-cloud">
        <button class="tag-btn active" data-tag="All">
          All <span class="tag-count">{allPosts.length}</span>
        </button>
        {sortedTags.map(({ tag, count }) => (
          <button class="tag-btn" data-tag={tag}>
            {tag} <span class="tag-count">{count}</span>
          </button>
        ))}
      </div>

      <!-- 结果标题 -->
      <h2 class="result-title" id="result-title">All Posts</h2>

      <!-- 文章列表 -->
      <div class="post-list" id="post-list">
        <!-- 由 JS 渲染 -->
      </div>

      <div class="not-found" id="not-found" style="display: none;">
        Not found
      </div>
    </div>
  </main>
</Layout>

<script define:vars={{ postsData }}>
  // 渲染文章列表
  function renderPosts(posts) {
    const container = document.getElementById('post-list');
    container.innerHTML = posts.map(post => `
      <article class="post-card" data-tags="${post.tags.join(' ')}">
        <a href="/post/${post.id}" class="post-link">
          <div class="post-header">
            <h3 class="post-title">${escapeHtml(post.title)}</h3>
            <time class="post-date">${formatDate(post.createTime)}</time>
          </div>
          <p class="post-intro">${escapeHtml(post.intro || '')}</p>
          <div class="post-tags">
            ${post.tags.map(tag => `<span class="post-tag">${escapeHtml(tag)}</span>`).join('')}
          </div>
        </a>
      </article>
    `).join('');
  }

  // 初始化渲染
  renderPosts(postsData);

  // 工具函数
  function escapeHtml(text) {
    if (!text) return '';
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  function formatDate(dateStr) {
    return new Date(dateStr).toISOString().split('T')[0];
  }

  // 标签筛选
  document.getElementById('tag-cloud').addEventListener('click', (e) => {
    const btn = e.target.closest('.tag-btn');
    if (!btn) return;
    
    const tag = btn.dataset.tag;
    
    // 更新按钮状态
    document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // 筛选
    filterPosts(tag, null);
  });

  // 搜索
  document.getElementById('search-btn').addEventListener('click', doSearch);
  document.getElementById('search-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') doSearch();
  });

  function doSearch() {
    const query = document.getElementById('search-input').value.trim();
    
    // 清除标签选中
    document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
    
    filterPosts(null, query);
  }

  // 统一筛选函数
  function filterPosts(tag, searchQuery) {
    let filtered = postsData;
    
    // 标签筛选
    if (tag && tag !== 'All') {
      filtered = filtered.filter(p => p.tags.includes(tag));
    }
    
    // 搜索筛选
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      filtered = filtered.filter(p => 
        p.title.toLowerCase().includes(q) ||
        (p.intro && p.intro.toLowerCase().includes(q)) ||
        p.tags.some(t => t.toLowerCase().includes(q))
      );
    }
    
    // 渲染
    renderPosts(filtered);
    
    // 更新标题
    const titleEl = document.getElementById('result-title');
    if (searchQuery) {
      titleEl.textContent = `Search: "${searchQuery}"`;
    } else if (tag && tag !== 'All') {
      titleEl.textContent = `Tag: #${tag}`;
    } else {
      titleEl.textContent = 'All Posts';
    }
    
    // 显示/隐藏未找到
    const notFound = document.getElementById('not-found');
    notFound.style.display = filtered.length === 0 ? 'block' : 'none';
    notFound.textContent = searchQuery 
      ? `Not found "${searchQuery}"`
      : (tag && tag !== 'All' ? `No posts with tag #${tag}` : 'No posts');
    
    // 更新 URL
    const hash = searchQuery ? `search:${searchQuery}` : (tag && tag !== 'All' ? tag : '');
    window.location.hash = hash;
  }

  // 页面加载时解析 hash
  window.addEventListener('DOMContentLoaded', () => {
    const hash = decodeURIComponent(window.location.hash.slice(1));
    if (!hash) return;
    
    if (hash.startsWith('search:')) {
      const query = hash.slice(7);
      document.getElementById('search-input').value = query;
      doSearch();
    } else {
      const btn = document.querySelector(`[data-tag="${hash}"]`);
      if (btn) {
        document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterPosts(hash, null);
      }
    }
  });
</script>

<style>
  .page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #e8f4f4;
    margin-bottom: 1.5rem;
  }
  
  .search-box {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  
  .search-input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    background: #05282a;
    border: 1px solid #1a4a4c;
    border-radius: 4px;
    color: #e8f4f4;
    font-size: 0.9rem;
  }
  
  .search-input:focus {
    outline: none;
    border-color: #3da0a3;
  }
  
  .search-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(61, 160, 163, 0.1);
    border: 1px solid #1a4a4c;
    border-radius: 4px;
    color: #3da0a3;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .search-btn:hover {
    background: rgba(61, 160, 163, 0.15);
    color: #e8f4f4;
  }
  
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px dashed #1a4a4c;
  }
  
  .tag-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.75rem;
    background: #05282a;
    border: 1px solid #1a4a4c;
    border-radius: 4px;
    color: #8ab3b3;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .tag-btn:hover {
    border-color: #3da0a3;
    color: #b0d4d4;
  }
  
  .tag-btn.active {
    background: rgba(61, 160, 163, 0.2);
    border-color: #3da0a3;
    color: #e8f4f4;
  }
  
  .tag-count {
    padding: 0.1rem 0.4rem;
    background: #1a4a4c;
    border-radius: 3px;
    font-size: 0.75rem;
    color: #b0d4d4;
  }
  
  .result-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #e8f4f4;
    margin-bottom: 1rem;
  }
  
  .post-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .post-card {
    padding: 1rem;
    background: #05282a;
    border: 1px solid #1a4a4c;
    border-radius: 6px;
    transition: all 0.2s;
  }
  
  .post-card:hover {
    border-color: #2a7c7e;
  }
  
  .post-link {
    display: block;
    text-decoration: none;
  }
  
  .post-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }
  
  .post-title {
    font-size: 1rem;
    font-weight: 600;
    color: #e8f4f4;
    margin: 0;
  }
  
  .post-date {
    font-size: 0.75rem;
    color: #8ab3b3;
    font-family: "SF Mono", monospace;
    white-space: nowrap;
  }
  
  .post-intro {
    font-size: 0.85rem;
    color: #8ab3b3;
    margin: 0 0 0.75rem 0;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }
  
  .post-tag {
    padding: 0.15rem 0.5rem;
    background: #0a3d3f;
    border-radius: 3px;
    font-size: 0.75rem;
    color: #3da0a3;
  }
  
  .not-found {
    text-align: center;
    padding: 3rem;
    color: #8ab3b3;
    font-size: 1.1rem;
  }
</style>
