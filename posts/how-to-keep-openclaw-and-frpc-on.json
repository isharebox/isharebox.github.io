{"__ud_title":"how to keep openclaw and frpc on","__ud_tags":[],"__ud_update_time":1771145029496,"__ud_create_time":1770466050849,"__ud_draft":false,"type":"doc","content":[{"type":"heading","attrs":{"level":1,"id":"how-to-keep-openclaw-and-frpc-on"},"content":[{"type":"text","text":"how to keep openclaw and frpc on"}]},{"type":"heading","attrs":{"level":3,"id":"问题场景"},"content":[{"type":"text","text":"问题场景"}]},{"type":"paragraph","content":[{"type":"text","text":"在 Android 设备上运行 frpc（内网穿透客户端）和 OpenClaw 时，面临以下挑战："}]},{"type":"orderedList","attrs":{"start":1,"type":null},"content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"手机重启后服务不自动启动"},{"type":"text","text":" - Android 系统不会自动运行 Termux 中的后台服务"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"进程崩溃后不会重启"},{"type":"text","text":" - frpc 或 OpenClaw 可能因网络波动、内存不足等原因崩溃，需要手动介入"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"无法方便地查看日志"},{"type":"text","text":" - 后台运行的进程没有会话管理，调试困难"}]}]}]},{"type":"heading","attrs":{"level":3,"id":"需求"},"content":[{"type":"text","text":"需求"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"✅ 手机开机后 frpc + OpenClaw 自动启动"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"✅ 进程崩溃后自动检测并重启"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"✅ 方便查看运行日志"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"✅ 低资源占用（不频繁检测）"}]}]}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"方案概述"},"content":[{"type":"text","text":"方案概述"}]},{"type":"paragraph","content":[{"type":"text","text":"利用 Termux 生态中的三个工具组合："}]},{"type":"paragraph","content":[{"type":"text","text":"工具 作用 "},{"type":"text","marks":[{"type":"bold"}],"text":"termux:boot"},{"type":"text","text":" 开机时自动执行脚本 "},{"type":"text","marks":[{"type":"bold"}],"text":"termux-wake-lock"},{"type":"text","text":" 防止系统休眠杀死进程 "},{"type":"text","marks":[{"type":"bold"}],"text":"tmux"},{"type":"text","text":" 会话管理（保持进程运行、方便查看日志） "},{"type":"text","marks":[{"type":"bold"}],"text":"cron"},{"type":"text","text":" 定时任务（每5分钟检测进程存活）"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"依赖安装"},"content":[{"type":"text","text":"依赖安装"}]},{"type":"codeBlock","attrs":{"language":null},"content":[{"type":"text","text":"# 安装 tmux（会话管理）\npkg install tmux\n\n# 安装 cron（定时任务）\npkg install crontab\n\n# 安装 termux:boot（开机自启）\npkg install termux-boot\n"}]},{"type":"blockquote","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"termux:boot 安装后需要在 Android 设置中授权自启动权限"}]}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"脚本内容"},"content":[{"type":"text","text":"脚本内容"}]},{"type":"heading","attrs":{"level":3,"id":"1-OpenClaw-启动脚本-openclaw-runsh"},"content":[{"type":"text","text":"1. OpenClaw 启动脚本 ("},{"type":"text","marks":[{"type":"code"}],"text":"~/openclaw-run.sh"},{"type":"text","text":")"}]},{"type":"paragraph","content":[{"type":"text","text":"负责清理旧进程、重新启动 OpenClaw："}]},{"type":"codeBlock","attrs":{"language":null},"content":[{"type":"text","text":"#!/data/data/com.termux/files/usr/bin/bash\nset -e\n\nSESSION=\"openclaw\"\nPORT=\"18789\"\nNPM_BIN=\"$HOME/.npm-global/bin\"\nTOKEN_FILE=\"$HOME/.openclaw_token\"\n\n# 基础检查\nif ! command -v tmux >/dev/null 2>&1; then\n    echo \"[ERR] tmux not found. Install: pkg install tmux\"\n    exit 1\nfi\n\nif [ ! -d \"$NPM_BIN\" ]; then\n    echo \"[ERR] $NPM_BIN not found\"\n    exit 1\nfi\n\nif [ ! -f \"$TOKEN_FILE\" ]; then\n    echo \"[ERR] token file not found: $TOKEN_FILE\"\n    exit 1\nfi\n\nTOKEN=\"$(cat \"$TOKEN_FILE\" | tr -d '\\r ')\"\n\nmkdir -p \"$HOME/tmp\"\n\n# 杀掉旧 session\ntmux kill-session -t \"$SESSION\" 2>/dev/null || true\nsleep 1\n\n# 新建 session 并启动\ntmux new -d -s \"$SESSION\"\nsleep 1\n\ntmux send-keys -t \"$SESSION\" \\\n    \"export PATH=$NPM_BIN:\\$PATH; export TMPDIR=\\$HOME/tmp; export OPENCLAW_GATEWAY_TOKEN='$TOKEN'; openclaw gateway --bind lan --port $PORT --token \\$OPENCLAW_GATEWAY_TOKEN --allow-unconfigured\" \\\n    C-m\n\necho \"[OK] OpenClaw started in tmux session: $SESSION\"\n"}]},{"type":"heading","attrs":{"level":3,"id":"2-开机启动脚本-termuxbootservicessh"},"content":[{"type":"text","text":"2. 开机启动脚本 ("},{"type":"text","marks":[{"type":"code"}],"text":"~/.termux/boot/services.sh"},{"type":"text","text":")"}]},{"type":"paragraph","content":[{"type":"text","text":"手机开机时自动启动 crond、frpc 和 OpenClaw："}]},{"type":"codeBlock","attrs":{"language":null},"content":[{"type":"text","text":"#!/data/data/com.termux/files/usr/bin/bash\n\n# 1. 清理旧会话\ntmux kill-session -t frpc 2>/dev/null\ntmux kill-session -t openclaw 2>/dev/null\nsleep 1\n\n# 2. 启动 crond（关键）\ncrond\n\n# 3. 启动 frpc（持有 wake lock）\ntmux new-session -d -s frpc \"exec /data/data/com.termux/files/usr/bin/frpc -c /data/data/com.termux/files/usr/etc/frp/frpc.ini\"\n\n# 4. 启动 OpenClaw\ntmux new -d -s openclaw\nsleep 1\ntmux send-keys -t openclaw \"export PATH=/data/data/com.termux/files/home/.npm-global/bin:\\$PATH TMPDIR=\\$HOME/tmp; export OPENCLAW_GATEWAY_TOKEN=tokenac27a3d5; openclaw gateway --bind lan --port 18789 --token \\$OPENCLAW_GATEWAY_TOKEN --allow-unconfigured\" C-m\n"}]},{"type":"heading","attrs":{"level":3,"id":"3-frpc-启动脚本-termuxbootfrpc-startsh"},"content":[{"type":"text","text":"3. frpc 启动脚本 ("},{"type":"text","marks":[{"type":"code"}],"text":"~/.termux/boot/frpc-start.sh"},{"type":"text","text":")"}]},{"type":"paragraph","content":[{"type":"text","text":"负责启动 frpc 并持有 wake lock："}]},{"type":"codeBlock","attrs":{"language":null},"content":[{"type":"text","text":"#!/data/data/com.termux/files/usr/bin/bash\ntermux-wake-lock\nexec /data/data/com.termux/files/usr/bin/frpc -c /data/data/com.termux/files/usr/etc/frp/frpc.ini\n"}]},{"type":"blockquote","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"关键点"},{"type":"text","text":"：使用 "},{"type":"text","marks":[{"type":"code"}],"text":"exec"},{"type":"text","text":" 前缀确保 wake lock 正确持有"}]}]},{"type":"heading","attrs":{"level":3,"id":"4-进程监控脚本-monitorsh"},"content":[{"type":"text","text":"4. 进程监控脚本 ("},{"type":"text","marks":[{"type":"code"}],"text":"~/monitor.sh"},{"type":"text","text":")"}]},{"type":"codeBlock","attrs":{"language":null},"content":[{"type":"text","text":"#!/data/data/com.termux/files/usr/bin/bash\n\nLOG_FILE=$HOME/monitor.log\nMAX_LOG_LINES=1000\n\nlog() {\n    echo \"[$(date '+%Y-%m-%d %H:%M:%S')] $1\" >> \"$LOG_FILE\"\n}\n\ntrim_log() {\n    local lines=$(wc -l < \"$LOG_FILE\" 2>/dev/null || echo 0)\n    if [ \"$lines\" -gt \"$MAX_LOG_LINES\" ]; then\n        tail -n \"$MAX_LOG_LINES\" \"$LOG_FILE\" > \"$LOG_FILE.tmp\"\n        mv \"$LOG_FILE.tmp\" \"$LOG_FILE\"\n    fi\n}\n\nlog \"========== Monitor started ==========\"\n\n# frpc 检测\nif ! pgrep -f \"frpc\" > /dev/null; then\n    log \"frpc 进程不存在，准备重启...\"\n    tmux kill-session -t frpc 2>/dev/null\n    sleep 1\n    tmux new-session -d -s frpc \"exec /data/data/com.termux/files/usr/bin/frpc -c /data/data/com.termux/files/usr/etc/frp/frpc.ini\"\n    log \"frpc 重启命令已发送\"\nelse\n    log \"frpc 运行正常\"\nfi\n\n# OpenClaw 检测\nif ! pgrep -f \"openclaw.*gateway\" > /dev/null; then\n    log \"OpenClaw 进程不存在，准备重启...\"\n    bash ~/openclaw-run.sh > /dev/null 2>&1\n    sleep 3\n    if pgrep -f \"openclaw.*gateway\" > /dev/null; then\n        log \"OpenClaw 进程确认已启动\"\n    else\n        log \"OpenClaw 启动验证失败\"\n    fi\nelse\n    log \"OpenClaw 运行正常\"\nfi\n\ntrim_log\nlog \"========== Monitor finished ==========\"\n"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"操作步骤"},"content":[{"type":"text","text":"操作步骤"}]},{"type":"heading","attrs":{"level":3,"id":"第一步安装依赖"},"content":[{"type":"text","text":"第一步：安装依赖"}]},{"type":"codeBlock","attrs":{"language":null},"content":[{"type":"text","text":"pkg update && pkg install tmux crontab termux-api crond\n"}]},{"type":"heading","attrs":{"level":3,"id":"第二步创建脚本文件"},"content":[{"type":"text","text":"第二步：创建脚本文件"}]},{"type":"codeBlock","attrs":{"language":null},"content":[{"type":"text","text":"mkdir -p ~/.termux/boot\nchmod +x ~/.termux/boot/services.sh ~/.termux/boot/frpc-start.sh ~/openclaw-run.sh ~/monitor.sh\n"}]},{"type":"heading","attrs":{"level":3,"id":"第三步配置-cron"},"content":[{"type":"text","text":"第三步：配置 cron"}]},{"type":"codeBlock","attrs":{"language":null},"content":[{"type":"text","text":"crontab -e\n# 添加以下内容（每5分钟检测一次）\n*/5 * * * * /data/data/com.termux/files/home/monitor.sh\n"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"常用命令"},"content":[{"type":"text","text":"常用命令"}]},{"type":"paragraph","content":[{"type":"text","text":"操作 命令 查看 tmux 会话 "},{"type":"text","marks":[{"type":"code"}],"text":"tmux ls"},{"type":"text","text":" 查看 frpc 日志 "},{"type":"text","marks":[{"type":"code"}],"text":"tmux attach -t frpc"},{"type":"text","text":" 查看 OpenClaw 日志 "},{"type":"text","marks":[{"type":"code"}],"text":"tmux attach -t openclaw"},{"type":"text","text":" 杀掉 tmux 会话 "},{"type":"text","marks":[{"type":"code"}],"text":"tmux kill-session -t frpc/openclaw"},{"type":"text","text":" 手动执行检测 "},{"type":"text","marks":[{"type":"code"}],"text":"bash ~/monitor.sh"},{"type":"text","text":" 查看监控日志 "},{"type":"text","marks":[{"type":"code"}],"text":"tail -f ~/monitor.log"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"效果"},"content":[{"type":"text","text":"效果"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"手机重启"},{"type":"text","text":" → crond + frpc + OpenClaw "},{"type":"text","marks":[{"type":"bold"}],"text":"全部自动启动"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"进程崩溃"},{"type":"text","text":" → 5分钟内自动检测并重启"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"随时查看日志"},{"type":"text","text":" → "},{"type":"text","marks":[{"type":"code"}],"text":"tmux attach -t openclaw"}]}]}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"️-关键经验教训"},"content":[{"type":"text","text":"⚠️ 关键经验教训"}]},{"type":"orderedList","attrs":{"start":1,"type":null},"content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"termux:boot 只在开机时执行一次"},{"type":"text","text":"，杀进程后不会自动重启"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"boot 脚本不能用环境变量"},{"type":"text","text":"，必须硬编码 token 和 port"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"crond 必须加入 boot 脚本"},{"type":"text","text":"，否则进程监控不生效"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"monitor.sh 用绝对路径"},{"type":"text","text":"，cron 环境下 $PREFIX 不生效"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"bold"}],"text":"frpc 用 exec 启动"},{"type":"text","text":"，确保 wake lock 正确持有"}]}]}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2,"id":"参考资源"},"content":[{"type":"text","text":"参考资源"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"link","attrs":{"href":"https://wiki.termux.com/wiki/Termux:Boot","target":"_blank","rel":"noopener noreferrer nofollow","class":null}}],"text":"Termux Wiki - Boot"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"link","attrs":{"href":"https://wiki.termux.com/wiki/Cron","target":"_blank","rel":"noopener noreferrer nofollow","class":null}}],"text":"Termux Wiki - Cron"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","marks":[{"type":"link","attrs":{"href":"https://tmuxcheatsheet.com/","target":"_blank","rel":"noopener noreferrer nofollow","class":null}}],"text":"Tmux 常用命令"}]}]}]},{"type":"paragraph"}]}